version: '3.8'

services:
  # Nginx reverse proxy to solve Mixed Content issue
  api-proxy:
    image: nginx:alpine
    container_name: mangwale-api-proxy
    volumes:
      - ./nginx-proxy.conf:/etc/nginx/conf.d/default.conf:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api-proxy.rule=Host(`admin.mangwale.ai`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api-proxy.entrypoints=websecure"
      - "traefik.http.routers.api-proxy.tls=true"
      - "traefik.http.routers.api-proxy.tls.certresolver=letsencrypt"
      - "traefik.http.routers.api-proxy.priority=10"
      - "traefik.http.services.api-proxy.loadbalancer.server.port=80"

  dashboard:
    image: node:20-alpine
    container_name: mangwale-dashboard
    working_dir: /app
    command: sh -c "rm -rf .next && npm install && npm run dev"
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - NEXT_TELEMETRY_DISABLED=1
      # WebSocket connects to AI backend on host
      - NEXT_PUBLIC_WS_URL=http://host.docker.internal:3200
      - NEXT_PUBLIC_MANGWALE_AI_URL=http://host.docker.internal:3200
      - NEXT_PUBLIC_ADMIN_BACKEND_URL=http://host.docker.internal:3002
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - traefik-public
    labels:
      - "traefik.enable=true"
      
      # mangwale.ai - Landing page (root domain)
      - "traefik.http.routers.landing.rule=Host(`mangwale.ai`)"
      - "traefik.http.routers.landing.entrypoints=websecure"
      - "traefik.http.routers.landing.tls=true"
      - "traefik.http.routers.landing.tls.certresolver=letsencrypt"
      - "traefik.http.routers.landing.service=dashboard"
      - "traefik.http.routers.landing.priority=1"
      
      # chat.mangwale.ai - Public chat interface
      - "traefik.http.routers.chat.rule=Host(`chat.mangwale.ai`)"
      - "traefik.http.routers.chat.entrypoints=websecure"
      - "traefik.http.routers.chat.tls=true"
      - "traefik.http.routers.chat.tls.certresolver=letsencrypt"
      - "traefik.http.routers.chat.service=dashboard"
      - "traefik.http.routers.chat.priority=2"
      
      # admin.mangwale.ai - Admin dashboard
      - "traefik.http.routers.admin.rule=Host(`admin.mangwale.ai`)"
      - "traefik.http.routers.admin.entrypoints=websecure"
      - "traefik.http.routers.admin.tls=true"
      - "traefik.http.routers.admin.tls.certresolver=letsencrypt"
      - "traefik.http.routers.admin.service=dashboard"
      - "traefik.http.routers.admin.priority=2"
      
      # HTTP to HTTPS redirect for mangwale.ai
      - "traefik.http.routers.landing-http.rule=Host(`mangwale.ai`)"
      - "traefik.http.routers.landing-http.entrypoints=web"
      - "traefik.http.routers.landing-http.middlewares=redirect-to-https"
      
      # HTTP to HTTPS redirect for chat.mangwale.ai
      - "traefik.http.routers.chat-http.rule=Host(`chat.mangwale.ai`)"
      - "traefik.http.routers.chat-http.entrypoints=web"
      - "traefik.http.routers.chat-http.middlewares=redirect-to-https"
      
      # HTTP to HTTPS redirect for admin.mangwale.ai
      - "traefik.http.routers.admin-http.rule=Host(`admin.mangwale.ai`)"
      - "traefik.http.routers.admin-http.entrypoints=web"
      - "traefik.http.routers.admin-http.middlewares=redirect-to-https"
      
      # Service definition
      - "traefik.http.services.dashboard.loadbalancer.server.port=3000"
      
      # Middleware definition
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

  # REMOVED: This nginx proxy is no longer needed
  # WebSocket now goes through api.mangwale.ai directly to AI service
  # backend-proxy:
  #   image: nginx:alpine
  #   container_name: mangwale-backend-proxy

networks:
  traefik-public:
    external: true
    name: traefik_default
